rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================
    // REGLAS DE SEGURIDAD - OPT-SEC-002 + RBAC-001
    // Fecha: 2026-01-07
    // Actualizado: Fortificaci√≥n con helper functions y validaci√≥n estricta
    //              + Sistema RBAC con Custom Claims
    // 
    // PRINCIPIOS:
    // 1. M√≠nimo Privilegio: Solo acceso a datos propios
    // 2. Zero Trust: Validar ownership en cada operaci√≥n
    // 3. Solo Lectura: Frontend no puede escribir (Cloud Functions)
    // 4. RBAC: Roles via Custom Claims en el token
    // ============================================================

    // ============================================================
    // HELPER FUNCTIONS DE SEGURIDAD (OPT-SEC-002 + RBAC-001)
    // ============================================================
    
    // Verifica que el usuario est√° autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Verifica que el usuario es el propietario del recurso
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ‚úÖ RBAC-001: Verifica si el usuario es admin via Custom Claims
    // Firebase Best Practice: Verificar directamente en el token
    // Sin consulta adicional a Firestore (zero-cost, zero-latency)
    function isAdmin() {
      return isAuthenticated() && request.auth.token.admin == true;
    }
    
    // Verifica que una cuenta de portafolio pertenece al usuario
    function belongsToUser(accountId) {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/portfolioAccounts/$(accountId)) &&
             get(/databases/$(database)/documents/portfolioAccounts/$(accountId)).data.userId == request.auth.uid;
    }

    // ============================================================
    // COLECCIONES PRINCIPALES
    // ============================================================

    // ---- ASSETS ----
    // Lectura: Solo assets cuya cuenta pertenece al usuario
    // Escritura: BLOQUEADA - Solo via Cloud Functions
    match /assets/{assetId} {
      allow read: if belongsToUser(resource.data.portfolioAccount);
      allow write: if false;  // SEGURIDAD: Solo Cloud Functions pueden escribir
    }
    
    // ---- TRANSACTIONS ----
    // Lectura: Solo transacciones cuya cuenta pertenece al usuario
    // Nota: Transacciones antiguas no tienen userId, usan portfolioAccountId
    // Escritura: BLOQUEADA - Solo via Cloud Functions
    match /transactions/{txId} {
      allow read: if belongsToUser(resource.data.portfolioAccountId);
      allow write: if false;
    }
    
    // ---- PORTFOLIO ACCOUNTS ----
    // Lectura: Solo el propietario puede leer sus cuentas
    // Escritura: Usuario puede crear/editar sus propias cuentas
    // Nota: Los balances se actualizan via Cloud Functions
    match /portfolioAccounts/{accountId} {
      allow read: if isOwner(resource.data.userId);
      allow create: if isOwner(request.resource.data.userId);
      allow update, delete: if isOwner(resource.data.userId);
    }
    
    // ---- CURRENT PRICES ----
    // Lectura: Cualquier usuario autenticado (requerido para polling OPT-COST-005)
    // Escritura: SOLO backend (GoogleFinanceAPI/unifiedMarketDataUpdate)
    match /currentPrices/{symbol} {
      allow read: if isAuthenticated();
      allow write: if false;
    }
    
    // ---- CURRENCIES ----
    // Lectura: P√∫blica - requerido para registro de usuarios
    // Escritura: üîí RBAC-001 - Solo admins via Custom Claims
    // Nota: En producci√≥n, las escrituras se hacen via Cloud Functions
    //       Esta regla es un backup de seguridad adicional
    match /currencies/{currencyId} {
      allow read: if true;  // P√∫blico - requerido para registro
      allow write: if isAdmin();  // RBAC-001: Solo admins
    }
    
    // ---- USER DATA ----
    // Lectura/Escritura: Solo el propietario
    match /userData/{userId} {
      allow read, write: if isOwner(userId);
    }
    
    // ---- PORTFOLIO PERFORMANCE ----
    // Lectura: Solo el propietario
    // Escritura: SOLO backend (calculateDailyPortfolioPerformance)
    match /portfolioPerformance/{userId} {
      allow read: if isOwner(userId);
      allow write: if false;
      
      // Subcolecci√≥n dates (para vista "overall")
      match /dates/{dateId} {
        allow read: if isOwner(userId);
        allow write: if false;
      }
      
      // Subcolecci√≥n consolidatedPeriods (COST-OPT-001)
      match /consolidatedPeriods/{periodType} {
        allow read: if isOwner(userId);
        allow write: if false;
        
        match /periods/{periodId} {
          allow read: if isOwner(userId);
          allow write: if false;
        }
      }
      
      // Subcolecci√≥n accounts
      match /accounts/{accountId} {
        allow read: if isOwner(userId);
        allow write: if false;
        
        // Subcolecci√≥n dates (para vista por cuenta)
        match /dates/{dateId} {
          allow read: if isOwner(userId);
          allow write: if false;
        }
        
        // Subcolecci√≥n consolidatedPeriods por cuenta
        match /consolidatedPeriods/{periodType} {
          allow read: if isOwner(userId);
          allow write: if false;
          
          match /periods/{periodId} {
            allow read: if isOwner(userId);
            allow write: if false;
          }
        }
      }
    }
    
    // ---- CAT√ÅLOGOS (Solo Lectura) ----
    match /markets/{marketId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }
    
    // ---- SYSTEM STATUS (OPT-016) ----
    // Documento de se√±al para sincronizaci√≥n de rendimientos en tiempo real
    // Lectura: Cualquier usuario autenticado
    // Escritura: SOLO backend (unifiedMarketDataUpdate)
    match /systemStatus/{docId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }
    
    match /sectors/{sectorId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }
    
    match /assetTypes/{typeId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }
    
    // ---- PA√çSES Y MONEDAS (Lectura P√∫blica) ----
    // Necesarios para el formulario de registro antes de autenticarse
    match /countries/{countryId} {
      allow read: if true;  // P√∫blico - requerido para registro
      allow write: if false;
    }
    
    // ---- ETF DATA ----
    match /etfData/{etfId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }
    
    match /etfSectors/{etfId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }
    
    // ---- ETF ANALYSES (Usuario puede guardar sus an√°lisis) ----
    match /etfAnalyses/{analysisId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isOwner(resource.data.userId);
    }
    
    // ---- INDEX HISTORIES ----
    match /indexHistories/{indexId} {
      allow read: if isAuthenticated();
      allow write: if false;
      
      match /dates/{dateId} {
        allow read: if isAuthenticated();
        allow write: if false;
      }
    }
    
    // ---- INDEX CACHE (OPT-009) ----
    // Cache global de √≠ndices hist√≥ricos - solo lectura para usuarios autenticados
    // Las Cloud Functions escriben con privilegios de admin
    match /indexCache/{cacheId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }
    
    // ---- PORTFOLIO DISTRIBUTION/METRICS ----
    match /portfolioDistribution/{docId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }
    
    // ---- PORTFOLIO METRICS ----
    // Estructura:
    //   portfolioMetrics/{userId}/weeklyMetrics/latest
    //   portfolioMetrics/{userId}/riskMetrics/latest
    //   portfolioMetrics/{userId}/accounts/{accountId}/weeklyMetrics/latest
    //   portfolioMetrics/{userId}/accounts/{accountId}/riskMetrics/latest
    match /portfolioMetrics/{userId} {
      // Documento ra√≠z del usuario
      allow read: if isOwner(userId);
      allow write: if false;
      
      // Subcolecci√≥n weeklyMetrics (profitable weeks data)
      match /weeklyMetrics/{docId} {
        allow read: if isOwner(userId);
        allow write: if false;
      }
      
      // Subcolecci√≥n riskMetrics (portfolio risk data)
      match /riskMetrics/{docId} {
        allow read: if isOwner(userId);
        allow write: if false;
      }
      
      // Subcolecci√≥n accounts con sus m√©tricas
      match /accounts/{accountId} {
        allow read: if isOwner(userId);
        allow write: if false;
        
        // weeklyMetrics por cuenta
        match /weeklyMetrics/{docId} {
          allow read: if isOwner(userId);
          allow write: if false;
        }
        
        // riskMetrics por cuenta
        match /riskMetrics/{docId} {
          allow read: if isOwner(userId);
          allow write: if false;
        }
      }
    }
  }
}